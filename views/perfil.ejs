<!-- views/perfil.ejs -->
<section>
  <div class="padding chat-card centralized content">
    <div class="bordadaora tamanhodasinfo">
      <!-- SeÃ§Ã£o de informaÃ§Ãµes do usuÃ¡rio -->
      <div class="left-aligned">
        <img class="fotodolado" src="/imagens/<%= usuario.imagem %>">
        <h1><%= usuario.nome_artistico %></h1> <!-- Nome artÃ­stico do tatuador -->
        <h6><%= usuario.nome %></h6> <!-- Nome do tatuador -->
      </div>
      <div>
        <strong>Estilo de arte:</strong>
        <p><%= usuario.estilo %></p>
      </div>

      <!-- SeÃ§Ã£o de descriÃ§Ã£o -->
      <div class="description-section">
        <h5>DescriÃ§Ã£o</h5>
        <div id="descricao-texto" class="descricao-texto">
          <% if (!usuario.descricao) { %>
            <% if (usuario.tipo === 'cliente') { %>
              <p>VocÃª Ã© um cliente! ðŸ˜‰</p>
            <% } else { %>
              <p>Esse usuÃ¡rio ainda nÃ£o tem uma descriÃ§Ã£o ðŸ˜¥</p>
            <% } %>
          <% } else { %>
            <%= usuario.descricao %>
            <% } %>
          </div>
        </div>
        <form id="descricao-form">
          <textarea name="descricao" placeholder="Atualize sua descriÃ§Ã£o"></textarea>
          <input type="hidden" name="usuarioId" value="<%= usuario.id %>">
          <button type="submit">Atualizar</button>
        </form>

      <!-- SeÃ§Ã£o de comentÃ¡rios -->
      <div id="comments-section" class="comments-section">
        <h5>ComentÃ¡rios</h5>
        <ul id="comentarios-list" class="comentarios-list">
          <!-- Itera sobre a lista de comentÃ¡rios e exibe cada um -->
          <% comentarios.forEach(function(comentario) { %>
            <li class="comentario-item">
              <strong><%= comentario.usuarioNome %>:</strong>
              <p><%= comentario.texto %></p>
            </li>
          <% }); %>
        </ul>
        <!-- FormulÃ¡rio para adicionar um novo comentÃ¡rio -->
        <form id="comentario-form">
          <textarea name="texto" placeholder="Adicione um comentÃ¡rio"></textarea>
          <input type="hidden" name="usuarioNome" value="<%= usuarioLogado.nome %>"> <!-- Nome do usuÃ¡rio logado -->
          <input type="hidden" name="usuarioId" value="<%= usuario.id %>"> <!-- ID do tatuador -->
          <button type="submit">Enviar</button>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Atualizar descriÃ§Ã£o do perfil via AJAX
    const descricaoForm = document.getElementById('descricao-form');
    if (descricaoForm) {
      descricaoForm.addEventListener('submit', function (event) {
        event.preventDefault();
        const descricao = descricaoForm.querySelector('textarea[name="descricao"]').value;
        const usuarioId = descricaoForm.querySelector('input[name="usuarioId"]').value;

        fetch(`/perfil/${usuarioId}/descricao`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ descricao }),
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert(data.error);
          } else {
            document.getElementById('descricao-texto').innerText = data.descricao;
          }
        })
        .catch(error => console.error('Erro ao atualizar a descriÃ§Ã£o:', error));
      });
    }

    // Adicionar comentÃ¡rio via AJAX
    const comentarioForm = document.getElementById('comentario-form');
    if (comentarioForm) {
      comentarioForm.addEventListener('submit', function (event) {
        event.preventDefault();
        const formData = new FormData(comentarioForm);
        const comentarioData = {
          usuarioNome: formData.get('usuarioNome'),
          texto: formData.get('texto'),
          usuarioId: formData.get('usuarioId'),
        };

        fetch('/comentarios/adicionar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(comentarioData),
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert(data.error);
          } else {
            const comentarioItem = document.createElement('li');
            comentarioItem.classList.add('comentario-item');
            comentarioItem.innerHTML = `<strong>${data.usuarioNome}:</strong><p>${data.texto}</p>`;
            document.getElementById('comentarios-list').appendChild(comentarioItem);
            comentarioForm.reset();
          }
        })
        .catch(error => console.error('Erro ao adicionar o comentÃ¡rio:', error));
      });
    }
  });
</script>